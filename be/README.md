# Music Harmony Demo - å®Œæ•´é¡¹ç›®

ä¸€ä¸ªå®Œæ•´çš„ **Flutter + Python FastAPI** éŸ³ä¹ demo é¡¹ç›®ï¼Œå®ç°æ—‹å¾‹å’Œå£°ç”Ÿæˆä¸æ¼”å¥è¯„ä¼°åŠŸèƒ½ã€‚

## é¡¹ç›®æ¶æ„

```
Harmony10_demo/
â”œâ”€â”€ åç«¯ (Python FastAPI)
â”‚   â”œâ”€â”€ main.py              # FastAPI ä¸»åº”ç”¨
â”‚   â”œâ”€â”€ models.py            # Pydantic æ•°æ®æ¨¡å‹  
â”‚   â”œâ”€â”€ midi_utils.py        # MIDI ç”Ÿæˆå’Œè¯„ä¼°é€»è¾‘
â”‚   â”œâ”€â”€ run.py              # æœåŠ¡å¯åŠ¨è„šæœ¬
â”‚   â”œâ”€â”€ requirements.txt    # Python ä¾èµ–
â”‚   â””â”€â”€ TEST_GUIDE.md       # API æµ‹è¯•æŒ‡å—
â”‚
â””â”€â”€ å‰ç«¯ (Flutter)
    â”œâ”€â”€ lib/
    â”‚   â”œâ”€â”€ main.dart          # Flutter ä¸»åº”ç”¨
    â”‚   â”œâ”€â”€ models.dart        # æ•°æ®æ¨¡å‹
    â”‚   â””â”€â”€ api_service.dart   # HTTP å®¢æˆ·ç«¯
    â”œâ”€â”€ pubspec.yaml           # Flutter ä¾èµ–
    â””â”€â”€ README.md              # Flutter ä½¿ç”¨è¯´æ˜
```

## åŠŸèƒ½ç‰¹æ€§

### ğŸµ åŒæ¨¡å¼æ“ä½œ
- **Harmonize æ¨¡å¼**: å½•åˆ¶æ—‹å¾‹ â†’ ç”Ÿæˆå¸¦å’Œå£°çš„ MIDI æ–‡ä»¶
- **Evaluate æ¨¡å¼**: å½•åˆ¶æ¼”å¥ â†’ ä¸å‚è€ƒæ¨¡æ¿å¯¹æ¯”è¯„åˆ†

### ğŸ¹ ç”¨æˆ·ç•Œé¢
- é¡¶éƒ¨æ¨¡å¼åˆ‡æ¢ (Harmonize/Evaluate)
- 7 ä¸ªç™½é”®æŒ‰é’® (C-D-E-F-G-A-Bï¼Œé»˜è®¤ C4-B4)
- 10 ç§’å½•åˆ¶å€’è®¡æ—¶ï¼Œæ¯ç§’æœ€å¤š 1 ä¸ªäº‹ä»¶
- åŒç§’æœ€åä¸€æ¬¡ç‚¹å‡»ç”Ÿæ•ˆ

### ğŸ”„ åç«¯å¤„ç†
- **Harmonize**: POST `/api/v1/harmonize` â†’ è¿”å› MIDI æ–‡ä»¶ (bytes)
- **Evaluate**: POST `/api/v1/evaluate` â†’ è¿”å› `{score, subscores, mistakes, advice}`

### ğŸŒ å±€åŸŸç½‘éƒ¨ç½²
- FastAPI åç«¯: `http://<å±€åŸŸç½‘IP>:8000`
- Flutter å‰ç«¯: ç§»åŠ¨è®¾å¤‡æˆ–æ¡Œé¢åº”ç”¨

## å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨åç«¯æœåŠ¡

```bash
# è¿›å…¥é¡¹ç›®æ ¹ç›®å½•
cd Harmony10_demo

# å®‰è£… Python ä¾èµ–
pip install -r requirements.txt

# å¯åŠ¨ FastAPI æœåŠ¡å™¨
python run.py
```

æœåŠ¡å™¨å°†è¿è¡Œåœ¨ `http://127.0.0.1:8000`

### 2. é…ç½®å’Œè¿è¡Œå‰ç«¯

```bash
# è¿›å…¥ Flutter ç›®å½•
cd flutter_app

# å®‰è£… Flutter ä¾èµ–  
flutter pub get

# ä¿®æ”¹ lib/api_service.dart ä¸­çš„ IP åœ°å€
# static const String baseUrl = 'http://192.168.1.100:8000';

# è¿è¡Œ Flutter åº”ç”¨
flutter run
```

## æŠ€æœ¯è§„èŒƒ

### éŸ³ä¹å‚æ•°
- **Quantization**: å›ºå®šä¸º 1s (t_sec âˆˆ [0..9])
- **Key**: å›ºå®š C major
- **ç™½é”®é›†åˆ**: {60,62,64,65,67,69,71} (C,D,E,F,G,A,B)
- **å†²çªå¤„ç†**: åŒä¸€ç§’åªä¿ç•™æœ€åä¸€æ¬¡ç‚¹å‡»
- **é»˜è®¤åŠ›åº¦**: vel = 96

### MIDI è¾“å‡ºè§„èŒƒ
- **æ ¼å¼**: Type-1 MIDI æ–‡ä»¶
- **è½¨é“1**: æ—‹å¾‹ (Channel 1, Program 0 - Piano)
- **è½¨é“2**: å’Œå£° (Channel 2, Program 48 - String Ensemble)  
- **å’Œå£°è§„å¾‹**: C(0-3s) / F(4-6s) / G(7-9s)

### API é”™è¯¯ç 
- `unsupported_version` - ä¸æ”¯æŒçš„ç‰ˆæœ¬å·
- `invalid_mode` - æ— æ•ˆçš„æ¨¡å¼
- `invalid_duration` - æ— æ•ˆçš„æ—¶é•¿
- `invalid_quantize` - æ— æ•ˆçš„é‡åŒ–è®¾ç½®
- `empty_sequence` - ç©ºçš„äº‹ä»¶åºåˆ—
- `duplicate_timeslot` - é‡å¤çš„æ—¶é—´æ®µ
- `invalid_note` - æ— æ•ˆçš„éŸ³ç¬¦
- `reference_not_found` - å‚è€ƒæ¨¡æ¿æœªæ‰¾åˆ°

## ä½¿ç”¨æµç¨‹

### Harmonize æ¨¡å¼
1. åˆ‡æ¢åˆ° "Harmonize" æ¨¡å¼
2. ç‚¹å‡»"å¼€å§‹å½•åˆ¶"ï¼Œ10ç§’å€’è®¡æ—¶å¼€å§‹
3. åœ¨å€’è®¡æ—¶æœŸé—´ç‚¹å‡»ç™½é”®å½•åˆ¶æ—‹å¾‹
4. å½•åˆ¶ç»“æŸè‡ªåŠ¨è°ƒç”¨åç«¯ç”Ÿæˆ MIDI æ–‡ä»¶
5. æ˜¾ç¤ºæ–‡ä»¶ä¿å­˜æˆåŠŸä¿¡æ¯

### Evaluate æ¨¡å¼  
1. åˆ‡æ¢åˆ° "Evaluate" æ¨¡å¼
2. ç‚¹å‡»"å¼€å§‹å½•åˆ¶"ï¼Œ10ç§’å€’è®¡æ—¶å¼€å§‹
3. æŒ‰ç…§å‚è€ƒæ¨¡æ¿ (exercise_c_major_01) æ¼”å¥
4. å½•åˆ¶ç»“æŸè‡ªåŠ¨è°ƒç”¨åç«¯è¿›è¡Œè¯„ä¼°
5. æ˜¾ç¤ºè¯„åˆ†ç»“æœå’Œæ”¹è¿›å»ºè®®

## å†…ç½®å‚è€ƒæ¨¡æ¿

### exercise_c_major_01 (Cå¤§è°ƒç»ƒä¹ )
```
0s -> C(60)    1s -> D(62)    2s -> E(64)    3s -> F(65)    4s -> G(67)
5s -> A(69)    6s -> B(71)    7s -> C(60)    8s -> D(62)    9s -> E(64)
```

## æµ‹è¯•ç¤ºä¾‹

### æµ‹è¯• Harmonize æ¥å£
```bash
curl -X POST "http://127.0.0.1:8000/api/v1/harmonize" \
     -H "Content-Type: application/json" \
     -d '{
       "version":"1.0","mode":"harmonize","duration_sec":10,"quantize":"1s",
       "octave_base":"C4","key":"C major","return_mode":"bytes",
       "events":[{"t_sec":0,"note":60},{"t_sec":3,"note":64},{"t_sec":7,"note":67}]
     }' \
     --output harmony.mid
```

### æµ‹è¯• Evaluate æ¥å£
```bash
curl -X POST "http://127.0.0.1:8000/api/v1/evaluate" \
     -H "Content-Type: application/json" \
     -d '{
       "version":"1.0","mode":"evaluate","duration_sec":10,"quantize":"1s",
       "octave_base":"C4","key":"C major","reference_id":"exercise_c_major_01",
       "events":[{"t_sec":0,"note":60},{"t_sec":1,"note":62},{"t_sec":2,"note":64}]
     }'
```

## éƒ¨ç½²è¯´æ˜

### å±€åŸŸç½‘éƒ¨ç½²

1. **åç«¯éƒ¨ç½²**
   - åœ¨æœåŠ¡å™¨æˆ–ä¸»æœºä¸Šè¿è¡Œ `python run.py`
   - ç¡®ä¿ç«¯å£ 8000 åœ¨é˜²ç«å¢™ä¸­å¼€æ”¾
   - è®°å½•æœåŠ¡å™¨çš„å±€åŸŸç½‘ IP åœ°å€

2. **å‰ç«¯é…ç½®**  
   - ä¿®æ”¹ `flutter_app/lib/api_service.dart` ä¸­çš„ `baseUrl`
   - å°† IP åœ°å€æ”¹ä¸ºåç«¯æœåŠ¡å™¨çš„å±€åŸŸç½‘ IP
   - ç¡®ä¿ç§»åŠ¨è®¾å¤‡ä¸æœåŠ¡å™¨åœ¨åŒä¸€å±€åŸŸç½‘

### ç”Ÿäº§ç¯å¢ƒå»ºè®®

- **HTTPS**: é…ç½® SSL è¯ä¹¦
- **åå‘ä»£ç†**: ä½¿ç”¨ Nginx æˆ– Apache
- **åŸŸå**: é…ç½®åŸŸåè§£æ
- **ç›‘æ§**: æ·»åŠ æ—¥å¿—ç›‘æ§å’Œé”™è¯¯è·Ÿè¸ª

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ç½‘ç»œè¿æ¥å¤±è´¥**
   - æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ
   - ç¡®è®¤ IP åœ°å€é…ç½®æ­£ç¡®
   - æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

2. **MIDI æ–‡ä»¶ç”Ÿæˆå¤±è´¥**
   - ç¡®è®¤å½•åˆ¶äº†æœ‰æ•ˆéŸ³ç¬¦
   - æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿæƒé™

3. **è¯„ä¼°åŠŸèƒ½å¼‚å¸¸**
   - éªŒè¯å‚è€ƒæ¨¡æ¿å­˜åœ¨
   - ç¡®è®¤éŸ³ç¬¦åœ¨æœ‰æ•ˆèŒƒå›´å†…

### è°ƒè¯•å·¥å…·

- **åç«¯æ—¥å¿—**: `python run.py` ç»ˆç«¯è¾“å‡º
- **API æ–‡æ¡£**: `http://<IP>:8000/docs`
- **Flutter æ—¥å¿—**: `flutter logs`
- **ç½‘ç»œæµ‹è¯•**: æµè§ˆå™¨è®¿é—®åç«¯å¥åº·æ£€æŸ¥æ¥å£

## æŠ€æœ¯æ ˆ

### åç«¯
- **FastAPI**: ç°ä»£ Python Web æ¡†æ¶
- **Pydantic**: æ•°æ®éªŒè¯å’Œåºåˆ—åŒ–  
- **Mido**: MIDI æ–‡ä»¶å¤„ç†
- **Uvicorn**: ASGI æœåŠ¡å™¨

### å‰ç«¯
- **Flutter**: è·¨å¹³å° UI æ¡†æ¶
- **Dart**: ç¼–ç¨‹è¯­è¨€
- **HTTP**: ç½‘ç»œè¯·æ±‚åº“
- **Path Provider**: æ–‡ä»¶è·¯å¾„ç®¡ç†

## è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤é—®é¢˜æŠ¥å‘Šã€åŠŸèƒ½è¯·æ±‚å’Œä»£ç è´¡çŒ®ã€‚

### å¼€å‘ç¯å¢ƒ
- Python 3.8+
- Flutter 3.0+
- æ¨èä½¿ç”¨ VS Code æˆ– Android Studio

### æäº¤è§„èŒƒ  
- éµå¾ªä»£ç é£æ ¼æŒ‡å—
- æ·»åŠ å¿…è¦çš„æµ‹è¯•ç”¨ä¾‹
- æ›´æ–°ç›¸å…³æ–‡æ¡£

## è®¸å¯è¯

MIT License - è¯¦è§ LICENSE æ–‡ä»¶ã€‚
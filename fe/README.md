# Flutter 音乐和声 Demo

这是一个 Flutter 前端应用，配合 FastAPI 后端实现音乐和声生成和演奏评估功能。

## 功能特性

### 🎵 双模式操作
- **Harmonize 模式**: 录制旋律，生成带和声的 MIDI 文件
- **Evaluate 模式**: 录制演奏，与参考模板对比评分

### 🎹 交互界面
- 顶部模式切换按钮
- 7 个白键按钮 (C-D-E-F-G-A-B)
- 10 秒倒计时录制
- 实时录制状态显示

### 📊 结果展示
- **Harmonize**: 显示 MIDI 文件生成成功信息
- **Evaluate**: 显示总分、子分数、错误详情和改进建议

## 项目结构

```
flutter_app/
├── lib/
│   ├── main.dart          # 主应用和界面
│   ├── models.dart        # 数据模型
│   └── api_service.dart   # API 服务客户端
├── pubspec.yaml           # Flutter 依赖配置
└── README.md              # 项目说明
```

## 安装和运行

### 前置要求

1. **Flutter SDK** (>= 2.19.0)
2. **FastAPI 后端** 正在运行 (参考上级目录的后端代码)

### 步骤

1. **修改后端 IP 地址**
   
   编辑 `lib/api_service.dart`，将 `baseUrl` 修改为你的局域网 IP：
   ```dart
   static const String baseUrl = 'http://192.168.1.100:8000'; // 修改此处
   ```

2. **安装依赖**
   ```bash
   cd flutter_app
   flutter pub get
   ```

3. **运行应用**
   ```bash
   flutter run
   ```

## 使用说明

### 基本操作流程

1. **选择模式**
   - 点击顶部的 "Harmonize" 或 "Evaluate" 按钮切换模式

2. **开始录制**
   - 点击红色的"开始录制"按钮
   - 倒计时 10 秒开始

3. **录制音符**
   - 在倒计时期间点击白键按钮 (C, D, E, F, G, A, B)
   - 每秒最多记录一个音符
   - 同一秒内的最后一次点击生效

4. **查看结果**
   - 录制结束后自动处理
   - **Harmonize**: 生成 MIDI 文件到应用文档目录
   - **Evaluate**: 显示评分和详细反馈

### 界面说明

#### 顶部区域
- **模式切换**: 在 Harmonize 和 Evaluate 模式间切换
- **录制状态**: 显示当前状态和剩余时间

#### 中部区域
- **钢琴键**: 7 个白键按钮，对应 C4-B4 音符
- **按键反馈**: 按下的键会变蓝色高亮

#### 底部区域
- **录制控制**: 开始/停止录制按钮
- **结果显示**: 根据模式显示不同的结果

### Harmonize 模式结果
- ✅ 显示 MIDI 文件生成成功
- 📁 显示文件名和保存位置
- 📊 显示录制的音符数量

### Evaluate 模式结果
- 🎯 **总分**: 0-100 分，颜色编码 (绿色≥80，橙色≥60，红色<60)
- 📊 **子分数**: 准确度和时机分数
- 💡 **建议**: 个性化的改进建议
- ❌ **错误详情**: 列出前 5 个错误 (漏音符、错音符、多余音符)

## 技术规范

### 音符映射
```
C: 60 (C4)    D: 62 (D4)    E: 64 (E4)    F: 65 (F4)
G: 67 (G4)    A: 69 (A4)    B: 71 (B4)
```

### 录制规则
- **时长**: 固定 10 秒
- **量化**: 1 秒精度
- **冲突处理**: 同一秒最后一次点击生效
- **白键限制**: 只支持 C 大调白键

### API 集成
- **后端地址**: 可配置的局域网 IP
- **超时时间**: 30 秒
- **错误处理**: 完整的异常捕获和用户友好的错误提示
- **连接检查**: 自动检测后端连接状态

## 故障排除

### 常见问题

1. **网络连接错误**
   - 确认后端服务正在运行 (`python run.py`)
   - 检查 IP 地址配置是否正确
   - 确认设备在同一局域网内

2. **无法生成 MIDI 文件**
   - 确认录制了至少一个音符
   - 检查应用的文件写入权限

3. **评估功能异常**
   - 确认后端包含 `exercise_c_major_01` 参考模板
   - 检查录制的音符是否在白键范围内

### 调试技巧

1. **查看网络请求**
   ```bash
   flutter logs
   ```

2. **检查后端连接**
   - 在浏览器访问 `http://<你的IP>:8000`
   - 应该看到 API 欢迎信息

3. **验证 JSON 数据**
   - 检查 API 请求和响应格式
   - 确认数据模型匹配

## 开发说明

### 主要组件

- **MusicHarmonyPage**: 主界面状态管理
- **ApiService**: HTTP 客户端封装
- **Models**: 数据传输对象

### 状态管理

使用 Flutter 内置的 `StatefulWidget` 进行状态管理：
- `currentMode`: 当前操作模式
- `isRecording`: 录制状态
- `recordedEvents`: 录制的音符事件
- `evaluationResult`: 评估结果数据

### 文件操作

- 使用 `path_provider` 包获取应用文档目录
- MIDI 文件自动命名并保存到本地

## 未来改进

- [ ] 添加 MIDI 文件播放功能
- [ ] 支持更多调性和八度
- [ ] 添加录制历史记录
- [ ] 实现音符可视化波形
- [ ] 支持导出和分享功能